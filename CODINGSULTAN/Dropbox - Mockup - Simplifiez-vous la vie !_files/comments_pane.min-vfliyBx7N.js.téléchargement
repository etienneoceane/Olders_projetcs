define(["require","exports","tslib","react","react-redux","modules/clean/account/email","modules/clean/account/email_verify_reasons","modules/clean/react/css","classnames","modules/core/i18n","modules/clean/auth/login_or_register/types","modules/clean/react_format","external/lodash","comments2/components/comment","comments2/components/comment_editor","comments2/components/comment_stream","comments2/components/comment_stream/comment_stream_error","comments2/components/coachmark_location","comments2/components/utils/guest_utils","modules/clean/react/comments2/actions_adapters/index","modules/clean/react/comments2/components/coachmark","modules/clean/react/comments2/components/sidebar_listener","modules/clean/react/comments2/components/util","modules/clean/react/comments2/util","modules/clean/react/comments2/data/logger","modules/clean/react/comments2/data/types","modules/clean/react/comments2/transforms","modules/clean/react/comments2/data/actions","modules/clean/react/file_viewer/data/selectors","modules/clean/react/comments2/data/selectors","modules/clean/react/comments2/data/perf_util","modules/clean/redux/types","modules/clean/react/comments2/data/mentions_api","modules/clean/previews/constants","modules/clean/react/comments2/components/comments_translations","modules/clean/react/comments2/components/tooltips","modules/clean/sharing/actions/sharing_actions","modules/constants/file_viewer"],(function(e,t,n,o,a,r,i,s,m,c,l,d,u,p,_,g,h,f,v,w,b,C,y,T,E,S,M,P,A,I,O,k,D,N,x,R,V,F){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),o=n.__importDefault(o),a=n.__importStar(a),i=n.__importStar(i),m=n.__importDefault(m),u=n.__importStar(u),E=n.__importStar(E),I=n.__importStar(I),O=n.__importStar(O);var U=["image_preview_surface","document_preview_surface","how_to_at_mention_comments_pane_surface"];function L(e,t){return void 0===t&&(t=1),e===N.PreviewType.SsrDoc?{type:"document",regionType:"rectangle",regions:[n.__assign({page:t},T.createFullRectangle())]}:{type:"image",region:T.createFullRectangle()}}function q(e){var t=e.currentPageIndex,a=void 0===t?0:t,r=e.disabledTimeCodeTooltipComponent,i=e.playerCurrentTime,s=void 0===i?0:i,m=e.pendingNumberedAnnotation,c=e.previewType;if(c===N.PreviewType.Audio||c===N.PreviewType.Video){var l=c===N.PreviewType.Audio?"audio":"video";return o.default.createElement(_.TimeCodedCommentEditor,n.__assign({},e,{pendingAnnotation:{type:l,time:s},tooltipComponent:r}))}return c===N.PreviewType.SsrDoc||c===N.PreviewType.Image?o.default.createElement(_.NumberedCommentEditor,n.__assign({},e,{defaultAnnotation:L(c,a+1),pendingAnnotation:m})):o.default.createElement(_.CommentEditor,n.__assign({},e))}t.createDefaultNumberedAnnotation=L;var Q=(function(a){function s(t){var s=a.call(this,t)||this;return s.mentionsQueryId=0,s.onCommentStreamRef=function(e){return s.commentStream=e},s.updateMentionsMatches=function(e){s.setState({mentionsMatches:e})},s.logMentionsQueryCompletedPerf=function(e){var t=O.mentionsQueryCompleted();s.props.dispatch(P.Actions.logPerfEvent(t,e))},s.reloadComments=function(){s.props.dispatch(P.Actions.listComments(!0))},s.onMentionsQueryUpdated=function(e){if(e){var t=++s.mentionsQueryId;s.mentionsApi.query(e,s.updateMentionsMatches,O.withTiming(s.updateMentionsMatches,(function(e){s.mentionsQueryId===t&&s.logMentionsQueryCompletedPerf(e)})))}else""===e&&s.updateMentionsMatches(s.mentionsApi.getMatchesWithStarterSuggestions());s.props.dispatch(P.Actions.markOnboardedIfUnmarked("how_to_at_mention_comments_pane_surface"))},s.onPostSuccess=function(e,t){e.metadata&&e.metadata.some((function(e){return"mention"===e.type}))&&V.SharingActions.listMembers({user:t,contentId:s.props.stream.id,isFolder:!1,url:s.props.stream.linkUrl,includeSeenState:!1})},s.showEmailVerifyModal=function(e){if(!s.props.hasShownAnyModalVariant||e!==S.ShowModalReason.EditorFocus){s.props.dispatch(P.Actions.markModalVariantShown(S.ModalVariant.EmailVerifyModal)),E.logEvent("email_verify_modal_shown",{stream:s.props.stream});r.EmailVerification.get_for_user(s.props.viewer).show_verify_modal((function(){E.logEvent("email_verify_flow_completed",{stream:s.props.stream})}),i.ADD_COMMENT)}},s.showSignUpModal=function(t){if(!s.props.hasShownAnyModalVariant||t!==S.ShowModalReason.EditorFocus){s.props.dispatch(P.Actions.markModalVariantShown(S.ModalVariant.SignUpModal)),n.__awaiter(s,void 0,void 0,(function(){var t,a,r,i,s=this;return n.__generator(this,(function(m){switch(m.label){case 0:return[4,Promise.all([new Promise((function(t,n){e(["modules/clean/react/modal"],t,n)})).then(n.__importStar),new Promise((function(t,n){e(["modules/clean/auth/login_or_register/modal"],t,n)})).then(n.__importStar),new Promise((function(t,n){e(["modules/core/browser"],t,n)})).then(n.__importStar)])];case 1:return t=m.sent(),a=t[0].Modal,r=t[1].LoginOrRegisterModal,i=t[2],E.logEvent("sign_up_modal_shown",{stream:this.props.stream}),a.showInstance(o.default.createElement(r,{commentParams:{stream:this.props.stream,variant:l.CommentTextVariant.POST},downloadAction:null,id:"shared-link-default-comments-signup-modal",kind:l.LoginOrRegisterKind.COMMENT,onAuthenticateSuccess:function(){return i.reload()},onCancel:function(){return E.logEvent("sign_up_modal_dismissed",{stream:s.props.stream})},showAppleLogin:F.SHOW_APPLE_LOGIN,signup_tag:"comments_shmodel_modal_register"})),[2]}}))}))}},s.dismissImagePreviewSurfaceOnboarding=function(){s.dismissOnboarding(),s.markOnboarded("image_preview_surface")},s.dismissDocumentPreviewSurfaceOnboarding=function(){s.dismissOnboarding(),s.markOnboarded("document_preview_surface")},s.dismissHowToAtMentionOnoarding=function(){s.dismissOnboarding(),s.markOnboarded("how_to_at_mention_comments_pane_surface")},s.createComment=function(e){switch(s.props.previewType){case N.PreviewType.Video:case N.PreviewType.Audio:return o.default.createElement(p.TimeCodedComment,n.__assign({},e,{playerIntegrationEnabled:s.props.playerIntegrationEnabled}));case N.PreviewType.Image:case N.PreviewType.SsrDoc:return o.default.createElement(p.NumberedComment,n.__assign({},e));default:return o.default.createElement(p.Comment,n.__assign({},e))}},s.createEditor=function(e){var t=s.props,a=t.currentPageIndex,r=t.pendingNumberedAnnotation,i=t.playerCurrentTime,m=t.playerIntegrationEnabled,c=t.previewType,l=m?"target-annotation":"target-mention";return o.default.createElement(_.CoachMarkContainer,{className:l},o.default.createElement(q,n.__assign({},e,{disabledTimeCodeTooltipComponent:m?void 0:s.createDisabledTimeCodeTooltip,pendingNumberedAnnotation:r,currentPageIndex:a,playerIntegrationEnabled:m,playerCurrentTime:i,previewType:c})))},s.createDisabledTimeCodeTooltip=function(e){return o.default.createElement(R.DisabledTimeCodeTooltip,n.__assign({},e,{onClick:s.onDisabledTooltipLearnMoreClick,onShow:s.onDisabledTooltipShow}))},s.onDisabledTooltipLearnMoreClick=function(){return E.logEvent("time_based_tooltip_learn_more_click",{stream:s.props.stream})},s.onDisabledTooltipShow=function(){return E.logEvent("time_based_tooltip_learn_more_view",{stream:s.props.stream})},s.markOnboarded=function(e){s.props.dispatch(P.Actions.markOnboarded(e))},s.dismissOnboarding=function(){s.props.dispatch(P.Actions.dismissOnboarding(null))},s.mentionsApi=D.mentionsApi(t.viewer),s.state={mentionsMatches:s.mentionsApi.cache},s}return n.__extends(s,a),s.prototype.componentDidMount=function(){var e=this.props,t=e.dispatch,n=e.showOnboarding,o=e.perfEvents,a=e.stream,r=+new Date;E.logEvent("show_comments",{stream:a}),t(P.Actions.logSimplePerfEvent("stream_displayed_ms",r-(o.listCompleteTime||0))),t(P.Actions.logSimplePerfEvent("comment_editor_tti_ms",r-(o.setContextTime||0))),n&&E.logEvent("sidebar_onboarding_shown",{stream:a})},s.prototype.componentDidUpdate=function(e){var t=e.requestEditorFocus,n=e.showOnboarding,o=this.props,a=o.showOnboarding,r=o.dispatch,i=o.requestEditorFocus,s=o.stream;!n&&a&&E.logEvent("sidebar_onboarding_shown",{stream:s}),!t&&i&&(this.commentStream.focusPrimaryEditor(),r(P.Actions.fulfillEditorFocusRequest()))},Object.defineProperty(s.prototype,"onboardingKeysToMarkOnThreadCreation",{get:function(){return u.difference(this.props.relevantOnboardingKeys,U)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"imagePdfCoachmarkData",{get:function(){var e=this,t=this.props,a=t.showOnboarding,r=t.relevantOnboardingKeys,i=c._("Animation of annotating a file",{comment:"This is alt text for an animated gif"}),s=a&&u.head(u.intersection(U,r)),m={title:o.default.createElement("h2",{className:"sc-coachmark-title"}),body:o.default.createElement("p",null)};switch(s){case"document_preview_surface":return{location:f.CoachmarkLocations.BELOW_COMMENT_STREAM,component:function(t){return o.default.createElement(b.CommentsCoachmark,n.__assign({},t,{overrideArrowPlacement:"left",onClose:e.dismissDocumentPreviewSurfaceOnboarding}),o.default.createElement(y.Comments2OnboardingImage,{fileNamePrefix:"02_Comments2_PDFComments","aria-label":i}),d.reactFormat(c._("<title>Call it out</title> <body>Select an area on the file to highlight and comment.</body>"),m))}};case"image_preview_surface":return{location:f.CoachmarkLocations.BELOW_COMMENT_STREAM,component:function(t){return o.default.createElement(b.CommentsCoachmark,n.__assign({},t,{overrideArrowPlacement:"left",onClose:e.dismissImagePreviewSurfaceOnboarding}),o.default.createElement(y.Comments2OnboardingImage,{fileNamePrefix:"01_Comments2_ImageComment","aria-label":i}),d.reactFormat(c._("<title>Call it out</title> <body>Select an area on the image to highlight and comment.</body>"),m))}};case"how_to_at_mention_comments_pane_surface":return{location:f.CoachmarkLocations.ABOVE_COMMENT_STREAM,target:f.CoachmarkTargets.MAIN_EDITOR_MENTION_BUTTON,component:function(t){return o.default.createElement(b.CommentsCoachmark,n.__assign({},t,{onClose:e.dismissHowToAtMentionOnoarding}),o.default.createElement(y.Comments2OnboardingImage,{fileNamePrefix:"03_Comments_AtMentions_v1","aria-label":c._("Animation of mentioning a user",{comment:"This is alt text for an animated gif"})}),d.reactFormat(c._("<title>Get the feedback you need</title> <body>Tag someone to work together on this file.</body>"),m))}};default:return}},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"actionsAdapter",{get:function(){var e=this.props.fileSidebarDispatch;return w.createActionsAdapter(this.props,e,this.onboardingKeysToMarkOnThreadCreation,this.onMentionsQueryUpdated,this.onPostSuccess,this.showSignUpModal,this.showEmailVerifyModal)},enumerable:!0,configurable:!0}),s.prototype.stickerSetsToStickerPacks=function(e){return e.map((function(e){return{url:e.url,stickers:e.stickers,description:e.description,name:e.name,id:e.set_id}}))},s.prototype.render=function(){var e,n=this.props,a=n.activeThreadId,r=n.collapsed,i=n.dispatch,s=n.editorIsEmpty,c=n.focusedThreadId,l=n.hoverThreadId,d=n.isMobile,u=n.showResolved,p=n.showCommentsError,_=n.stream.id,f=n.thirdPartySource,w=n.threads,b=n.viewer,y=n.previewType,E=n.streamSettings,S=n.stickers,P=n.upsellTooltipVariant,A=w.filter((function(e){return u||!e.resolvedInfo}));e=b?M.dbxUserToIUser(b):v.getGuestIUser();var I=y===N.PreviewType.Image||y===N.PreviewType.SsrDoc;return o.default.createElement("div",{className:m.default("comments-pane-wrapper",{"no-comment":d&&0===A.length,"comments-pane-wrapper-show-resolved":u,"comments-pane-wrapper-hide-resolved":!u,"comments-pane-wrapper-all-changes-saved":!w.some((function(e){return!!e.pending})),"comments-upsell-eligible":!!P,"comments-upsell-ineligible":!P})},d&&o.default.createElement(t.MobileCommentsTitle,{commentCount:A.length}),p&&o.default.createElement(h.CommentStreamError,{intl:x.comments2Intl,onClickRetry:this.reloadComments}),o.default.createElement(g.CommentStream,{ref:this.onCommentStreamRef,id:_,actionsAdapter:this.actionsAdapter,commentComponent:this.createComment,editorComponent:this.createEditor,enabled:!0,isMobile:d,mentionsMatches:this.state.mentionsMatches,settings:E,threads:A,user:e,activeThreadID:a,focusedThreadID:c,hoverThreadID:l,showUnreadPill:T.canShowUnreadPill(),localization:x.commentsMasterLocalization,collapsed:r,coachmarkData:this.imagePdfCoachmarkData,showRevisionInfo:I,stickerPacks:S&&this.stickerSetsToStickerPacks(S),thirdPartySource:f}),o.default.createElement(C.SidebarListener,{dispatch:i,editorIsEmpty:s,stream:this.props.stream}))},s})(o.default.Component);t.CommentsPaneComponent=Q,t.MobileCommentsTitle=function(e){return o.default.createElement("div",{className:"comments-pane-wrapper__mobile-comments-title"},c._("Comments · %(count)d",{comment:"Title shown on top of web previews comments, indicating the number of comment threads"}).format({count:e.commentCount}))};var K=a.connect((function(e){var t=I.getContext(e),n=t.stream,o=t.viewer,a=I.getData(e),r=a.perfEvents,i=a.upsellExperimentNotDismissed,s=a.upsellTooltipVariant;return{activeThreadId:I.getActivatedThreadId(e),editorIsEmpty:I.getEditorIsEmpty(e),focusedThreadId:I.getFocusedThreadId(e),hasShownAnyModalVariant:I.getHasShownAnyModalVariant(e),hoverThreadId:I.getHoverThreadId(e),playerCurrentTime:I.getPlayerCurrentTime(e),playerIntegrationEnabled:I.getIsPlayerIntegrationEnabled(e),relevantOnboardingKeys:I.getUnmarkedOnboardingKeysRelevantToCurrentFile(e),showOnboarding:I.getShowOnboardingOnCommentsPane(e),showResolved:I.getShowResolved(e),pendingNumberedAnnotation:I.getPendingNumberedAnnotation(e),previewType:I.getPreviewTypeForCurrentFile(e),currentPageIndex:A.getCurrentPageIndex(e),showUpsellExperiment:!!o&&i,showCommentsError:I.getStatuses(e)[P.ActionTypes.ListComments.name]===k.ApiClientStatus.Error,stream:n,thirdPartySource:I.getThirdPartySource(e),threads:I.getThreads(e),viewer:o,upsellTooltipVariant:s,perfEvents:r,requestEditorFocus:I.getIsEditorFocusRequested(e),streamSettings:I.getStreamSettings(e),stickers:I.getStickers(e)}}))(Q);t.CommentsPane=s.requireCssWithComponent(K,["/static/js/comments2/index.web-vflXgfexW.css","/static/css/comments2-vflmLfLER.css","/static/css/snackbar-vfl8chDI1.css"])}));
//# sourceMappingURL=comments_pane.min.js-vflYysNgo.map